from copy import deepcopy
from unittest.mock import patch, PropertyMock

import pytest
from gsy_framework.constants_limits import ConstSettings
from gsy_framework.enums import AvailableMarketTypes
from math import isclose
from pendulum import duration, datetime

from gsy_e.models.area import Area
from gsy_e.models.strategy.forward.load import ForwardLoadStrategy
from gsy_e.models.strategy.forward.order_updater import OrderUpdaterParameters

CURRENT_MARKET_SLOT = datetime(2022, 6, 13, 0, 0)


class TestForwardLoadStrategy:

    def setup_method(self):
        ConstSettings.ForwardMarketSettings.ENABLE_FORWARD_MARKETS = True
        self.strategy = ForwardLoadStrategy(capacity_kW=100, order_updater_parameters={
            AvailableMarketTypes.INTRADAY: OrderUpdaterParameters(duration(minutes=5), 10, 40),
            AvailableMarketTypes.DAY_FORWARD: OrderUpdaterParameters(duration(minutes=30), 20, 40),
            AvailableMarketTypes.WEEK_FORWARD: OrderUpdaterParameters(duration(days=1), 30, 50),
            AvailableMarketTypes.MONTH_FORWARD: OrderUpdaterParameters(duration(weeks=1), 40, 60),
            AvailableMarketTypes.YEAR_FORWARD: OrderUpdaterParameters(duration(months=1), 50, 70)
        })
        self.strategy_area = Area("load", strategy=self.strategy)
        self.area = Area("grid", children=[self.strategy_area])

        self.area.config.start_date = CURRENT_MARKET_SLOT
        self.area.config.end_date = self.area.config.start_date.add(years=6)

    def teardown_method(self):
        ConstSettings.ForwardMarketSettings.ENABLE_FORWARD_MARKETS = False

    def _assert_posted_bids_on_markets(self, market_type, bid_count, energy_rate, energy):
        intraday = self.area.forward_markets[market_type]
        bids = intraday.get_bids().values()
        assert len(bids) == bid_count
        for bid in bids:
            assert bid.energy_rate == energy_rate
            assert bid.energy == energy
            assert bid.buyer == bid.buyer_origin == self.strategy.owner.name
            assert bid.buyer_id == bid.buyer_origin_id == self.strategy.owner.uuid

    @pytest.mark.parametrize("market_type, expected_order_updater_count, ", [
        (AvailableMarketTypes.INTRADAY, 24 * 4 - 1),
        (AvailableMarketTypes.DAY_FORWARD, 24 * 7 - 1),
        (AvailableMarketTypes.WEEK_FORWARD, 51),
        (AvailableMarketTypes.MONTH_FORWARD, 23),
        (AvailableMarketTypes.YEAR_FORWARD, 5),
    ])
    def test_order_updaters_follow_market_slots(self, market_type, expected_order_updater_count):
        self.area.activate()
        self.strategy.event_market_cycle()
        market_object = self.area.forward_markets[market_type]
        assert (
            list(self.strategy._order_updaters[market_object].keys()) ==
            market_object.market_time_slots)
        assert (
            len(self.strategy._order_updaters[market_object].keys()) ==
            expected_order_updater_count)

        with patch('gsy_e.models.area.Area.now', new_callable=PropertyMock) as now_mock:
            now_mock.return_value=CURRENT_MARKET_SLOT + duration(months=1)
            self.strategy.event_market_cycle()
            assert (
                    list(self.strategy._order_updaters[market_object].keys()) ==
                    market_object.market_time_slots)
            assert (
                    len(self.strategy._order_updaters[market_object].keys()) ==
                    expected_order_updater_count)

    def test_load_forward_strategy_posts_bid_on_market_cycle(self):
        self.area.activate()
        self.strategy.event_market_cycle()
        self._assert_posted_bids_on_markets(AvailableMarketTypes.INTRADAY, 24 * 4 - 1, 10, 10)
        self._assert_posted_bids_on_markets(AvailableMarketTypes.DAY_FORWARD, 24 * 7 - 1, 20, 10)
        self._assert_posted_bids_on_markets(AvailableMarketTypes.WEEK_FORWARD, 51, 30, 10)
        self._assert_posted_bids_on_markets(AvailableMarketTypes.MONTH_FORWARD, 23, 40, 10)
        self._assert_posted_bids_on_markets(AvailableMarketTypes.YEAR_FORWARD, 5, 50, 10)

    @pytest.mark.parametrize("market_type, update_interval, initial_rate, final_rate, ", [
        (AvailableMarketTypes.INTRADAY, duration(minutes=5), 10, 40),
        (AvailableMarketTypes.DAY_FORWARD, duration(minutes=30), 20, 40),
        (AvailableMarketTypes.WEEK_FORWARD, duration(days=1), 30, 50),
        (AvailableMarketTypes.MONTH_FORWARD, duration(weeks=1), 40, 60),
        (AvailableMarketTypes.YEAR_FORWARD, duration(months=1), 50, 70),
    ])
    def test_load_forward_strategy_updates_bids_on_tick(
            self, market_type, update_interval, initial_rate, final_rate):
        self.area.activate()
        self.strategy.event_market_cycle()
        market_object = self.area.forward_markets[market_type]
        old_bids = deepcopy(market_object.slot_bid_mapping)

        # Assert that orders are not updated before the update interval
        with patch('gsy_e.models.area.Area.now', new_callable=PropertyMock) as now_mock:
            now_mock.return_value = CURRENT_MARKET_SLOT + update_interval - duration(seconds=1)
            self.strategy.event_tick()
            updated_bids = market_object.slot_bid_mapping
            for time_slot, old_bid_list in old_bids.items():
                if not old_bid_list:
                    continue
                assert updated_bids[time_slot][0].id == old_bid_list[0].id

        # Assert that orders are updated at exactly the update interval
        with patch('gsy_e.models.area.Area.now', new_callable=PropertyMock) as now_mock:
            now_mock.return_value = CURRENT_MARKET_SLOT + update_interval
            self.strategy.event_tick()
            updated_bids = market_object.slot_bid_mapping
            for time_slot, old_bid_list in old_bids.items():
                if not old_bid_list:
                    continue
                old_bid = old_bid_list[0]
                updated_bid = updated_bids[time_slot][0]
                assert updated_bid.id != old_bid.id
                assert updated_bid.energy == old_bid.energy
                assert updated_bid.buyer_id == old_bid.buyer_id
                market_params = market_object.get_market_parameters_for_market_slot(time_slot)
                slot_completion_ratio = update_interval.total_minutes() / (
                        market_params.close_timestamp - market_params.open_timestamp
                ).total_minutes()
                assert isclose(
                    updated_bid.energy_rate,
                    slot_completion_ratio * (final_rate - initial_rate) + initial_rate
                )
