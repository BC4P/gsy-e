from unittest.mock import MagicMock, call

import pendulum
import pytest
from gsy_framework.enums import AvailableMarketTypes

from gsy_e.models.area import Area
from gsy_e.models.strategy.energy_parameters.energy_params_eb import LoadSSPEnergyParameters
from gsy_e.models.strategy.load_hours import LoadHoursStrategy


@pytest.fixture(name="load")
def load_fixture():
    """Load asset."""
    return Area(
        "Load",
        strategy=LoadHoursStrategy(
            avg_power_W=200,
            hrs_per_day=6,
            hrs_of_day=list(range(12, 18)),
            final_buying_rate=35,
        ),
    )


class TestLoadSSPEnergyParameters:
    """Tests for the LoadSSPEnergyParameters class."""

    @staticmethod
    def test_event_traded_energy(load):
        energy_params = LoadSSPEnergyParameters(capacity_kW=200)
        state_mock = MagicMock()
        energy_params.state = state_mock
        # We call this method to set the area and the profile generator
        energy_params.event_activate_energy(load)

        market_slot = pendulum.datetime(2022, 2, 1)
        product_type = AvailableMarketTypes.DAY_FORWARD
        energy_params.event_traded_energy(
            energy_kWh=50,
            market_slot=market_slot,
            product_type=product_type)

        assert state_mock.decrement_energy_requirement.call_count == 96

        area_name = "Load"
        # We want to make sure that all the expected calls to the state class are correctly issued
        calls = [
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 0, 0)),
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 0, 15)),
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 0, 30)),
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 0, 45)),
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 1, 0)),
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 1, 15)),
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 1, 30)),
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 1, 45)),
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 2, 0)),
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 2, 15)),
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 2, 30)),
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 2, 45)),
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 3, 0)),
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 3, 15)),
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 3, 30)),
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 3, 45)),
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 4, 0)),
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 4, 15)),
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 4, 30)),
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 4, 45)),
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 5, 0)),
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 5, 15)),
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 5, 30)),
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 5, 45)),
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 6, 0)),
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 6, 15)),
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 6, 30)),
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 6, 45)),
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 7, 0)),
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 7, 15)),
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 7, 30)),
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 7, 45)),
            call(purchased_energy_Wh=964.9259187418431, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 8, 0)),
            call(purchased_energy_Wh=2124.7822377693897, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 8, 15)),
            call(purchased_energy_Wh=3452.5366995460276, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 8, 30)),
            call(purchased_energy_Wh=4928.760494487915, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 8, 45)),
            call(purchased_energy_Wh=6531.442853297769, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 9, 0)),
            call(purchased_energy_Wh=8236.34626547338, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 9, 15)),
            call(purchased_energy_Wh=10017.397951100218, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 9, 30)),
            call(purchased_energy_Wh=11847.111240228809, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 9, 45)),
            call(purchased_energy_Wh=13697.03002911166, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 10, 0)),
            call(purchased_energy_Wh=15538.189108297043, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 10, 15)),
            call(purchased_energy_Wh=17341.582900111225, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 10, 30)),
            call(purchased_energy_Wh=19078.635006586188, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 10, 45)),
            call(purchased_energy_Wh=20721.6609556183, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 11, 0)),
            call(purchased_energy_Wh=22244.316643283633, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 11, 15)),
            call(purchased_energy_Wh=23622.0252020159, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 11, 30)),
            call(purchased_energy_Wh=24832.37537399818, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 11, 45)),
            call(purchased_energy_Wh=25855.484930976603, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 12, 0)),
            call(purchased_energy_Wh=26674.323248274744, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 12, 15)),
            call(purchased_energy_Wh=27274.987802890748, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 12, 30)),
            call(purchased_energy_Wh=27646.930112456903, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 12, 45)),
            call(purchased_energy_Wh=27783.12745143142, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 13, 0)),
            call(purchased_energy_Wh=27680.19755987516, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 13, 15)),
            call(purchased_energy_Wh=27338.45448430118, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 13, 30)),
            call(purchased_energy_Wh=26761.904644384616, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 13, 45)),
            call(purchased_energy_Wh=25958.183188314884, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 14, 0)),
            call(purchased_energy_Wh=24938.431667543595, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 14, 15)),
            call(purchased_energy_Wh=23717.119012952273, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 14, 30)),
            call(purchased_energy_Wh=22311.808713590173, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 14, 45)),
            call(purchased_energy_Wh=20742.875971232126, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 15, 0)),
            call(purchased_energy_Wh=19033.179414924827, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 15, 15)),
            call(purchased_energy_Wh=17207.692696289516, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 15, 30)),
            call(purchased_energy_Wh=15293.101936683966, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 15, 45)),
            call(purchased_energy_Wh=13317.375550850405, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 16, 0)),
            call(purchased_energy_Wh=11309.313419419668, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 16, 15)),
            call(purchased_energy_Wh=9298.082717342957, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 16, 30)),
            call(purchased_energy_Wh=7312.747921553746, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 16, 45)),
            call(purchased_energy_Wh=5381.802615420326, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 17, 0)),
            call(purchased_energy_Wh=3532.7106783071454, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 17, 15)),
            call(purchased_energy_Wh=1791.4642962882974, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 17, 30)),
            call(purchased_energy_Wh=182.16595722686628, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 17, 45)),
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 18, 0)),
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 18, 15)),
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 18, 30)),
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 18, 45)),
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 19, 0)),
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 19, 15)),
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 19, 30)),
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 19, 45)),
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 20, 0)),
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 20, 15)),
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 20, 30)),
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 20, 45)),
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 21, 0)),
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 21, 15)),
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 21, 30)),
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 21, 45)),
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 22, 0)),
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 22, 15)),
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 22, 30)),
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 22, 45)),
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 23, 0)),
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 23, 15)),
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 23, 30)),
            call(purchased_energy_Wh=0.0, area_name=area_name,
                 time_slot=pendulum.datetime(2022, 2, 1, 23, 45))
        ]

        state_mock.decrement_energy_requirement.assert_has_calls(calls)
